<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container py-4">
  <div class="shop-hero mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <p class="mb-1 text-uppercase small opacity-75">Explore</p>
      <h2 class="fw-bold mb-1">Start Shopping</h2>
      <p class="mb-0">Browse fresh picks, add to cart, and checkout fast.</p>
    </div>
    <a href="/cart" class="btn btn-light text-primary fw-semibold">View Cart</a>
  </div>

  <div class="search-row mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="productSearch" class="form-label mb-1 text-muted small">Search products</label>
        <div class="input-group">
          <input id="productSearch" type="search" class="form-control" placeholder="Search by name..." aria-label="Search products">
          <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
        </div>
        <div class="results-count mt-1" id="productResultsCount">Showing 0 products</div>
      </div>
      <div class="col-md-4">
        <div class="d-flex flex-wrap gap-2">
          <button class="filter-chip active" data-filter="all">All</button>
          <button class="filter-chip" data-filter="in">In stock</button>
          <button class="filter-chip" data-filter="low">Low stock</button>
          <button class="filter-chip" data-filter="out">Out of stock</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="sortSelect" class="form-label mb-1 text-muted small">Sort</label>
        <select id="sortSelect" class="form-select">
          <option value="default">Default</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="name-asc">Name: A to Z</option>
        </select>
      </div>
    </div>
  </div>

  <div class="row g-4" id="productGrid">
    <% products.forEach(product => { 
         const inStock = product.quantity > 0;
         const lowStock = inStock && product.quantity < 10;
    %>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 product-tile" data-name="<%= product.productName.toLowerCase() %>" data-stock="<%= product.quantity %>" data-price="<%= product.price %>">
        <div class="card h-100 shadow-sm product-card card-hover">
          <a href="/product/<%= product.id %>" class="text-center mt-3">
            <img 
              src="/images/<%= product.image %>" 
              class="card-img-top img-fluid product-image"
              alt="<%= product.productName %>"
              loading="lazy"
              onerror="this.src='/images/placeholder.png';"
            />
          </a>

          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="card-title fw-semibold text-truncate mb-0" title="<%= product.productName %>">
                <%= product.productName %>
              </h6>
              <% if (!inStock) { %>
                <span class="badge bg-secondary stock-badge">Out of stock</span>
              <% } else if (lowStock) { %>
                <span class="badge bg-warning text-dark stock-badge">Low stock</span>
              <% } else { %>
                <span class="badge bg-success stock-badge">In stock</span>
              <% } %>
            </div>

            <p class="card-text fs-5 fw-bold text-primary mb-2">
              $<%= Number(product.price).toFixed(2) %>
            </p>

            <div class="mb-3">
              <label class="form-label small text-muted">Quantity</label>
              <% const maxSelectable = Math.max(1, Math.min(10, product.quantity || 0)); %>
              <select name="quantity" class="form-select" form="addToCartForm-<%= product.id %>" <%= inStock ? '' : 'disabled' %>>
                <% for (let q = 1; q <= maxSelectable; q++) { %>
                  <option value="<%= q %>"><%= q %></option>
                <% } %>
              </select>
            </div>

            <form 
              id="addToCartForm-<%= product.id %>" 
              action="/cart/add/<%= product.id %>" 
              method="POST" 
              class="mt-auto"
            >
              <button type="submit" class="btn btn-outline-primary w-100 fw-semibold" <%= inStock ? '' : 'disabled' %>>
                <%= inStock ? 'Add to Cart' : 'Out of Stock' %>
              </button>
            </form>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <div id="productNoResults" class="text-center py-4 bg-white rounded-3 shadow-sm mt-3" style="display:none;">
    <p class="mb-2">No products match your filters.</p>
    <button class="btn btn-outline-primary" id="resetFilters" type="button">Reset filters</button>
  </div>

  <div class="floating-cart glass px-3 py-2 d-flex align-items-center gap-2">
    <span class="fs-5">ðŸ›’</span>
    <div class="d-flex flex-column">
      <small class="text-muted mb-0">Ready to checkout?</small>
      <strong>View Cart</strong>
    </div>
    <a href="/cart" class="btn btn-primary btn-sm ms-auto">Cart</a>
  </div>
</div>

<script>
  (function() {
    const searchInput = document.getElementById('productSearch');
    const clearBtn = document.getElementById('clearSearch');
    const tiles = Array.from(document.querySelectorAll('.product-tile'));
    const chips = Array.from(document.querySelectorAll('.filter-chip'));
    const sortSelect = document.getElementById('sortSelect');
    const resultsCount = document.getElementById('productResultsCount');
    const noResults = document.getElementById('productNoResults');
    const resetFilters = document.getElementById('resetFilters');

    const setQueryParam = (key, value) => {
      const url = new URL(window.location.href);
      if (value) url.searchParams.set(key, value);
      else url.searchParams.delete(key);
      window.history.replaceState({}, '', url.toString());
    };

    const filterTiles = () => {
      const term = (searchInput?.value || '').trim().toLowerCase();
      const activeFilter = chips.find(c => c.classList.contains('active'))?.dataset.filter || 'all';
      let visibleCount = 0;

      tiles.forEach(tile => {
        const name = tile.dataset.name || '';
        const stock = parseInt(tile.dataset.stock, 10) || 0;
        const low = stock > 0 && stock < 10;

        let pass = !term || name.includes(term);
        if (activeFilter === 'in') pass = pass && stock > 0;
        if (activeFilter === 'low') pass = pass && low;
        if (activeFilter === 'out') pass = pass && stock <= 0;

        tile.style.display = pass ? '' : 'none';
        if (pass) visibleCount += 1;
      });

      if (resultsCount) {
        resultsCount.textContent = `Showing ${visibleCount} product${visibleCount === 1 ? '' : 's'}`;
      }
      if (noResults) {
        noResults.style.display = visibleCount === 0 ? '' : 'none';
      }

      setQueryParam('q', term || '');
      setQueryParam('filter', activeFilter === 'all' ? '' : activeFilter);
    };

    const sortTiles = () => {
      const value = sortSelect?.value || 'default';
      const grid = document.getElementById('productGrid');
      const sorted = [...tiles].sort((a, b) => {
        const priceA = parseFloat(a.dataset.price) || 0;
        const priceB = parseFloat(b.dataset.price) || 0;
        const nameA = a.dataset.name || '';
        const nameB = b.dataset.name || '';
        if (value === 'price-asc') return priceA - priceB;
        if (value === 'price-desc') return priceB - priceA;
        if (value === 'name-asc') return nameA.localeCompare(nameB);
        return 0;
      });
      sorted.forEach(tile => grid.appendChild(tile));
      setQueryParam('sort', value === 'default' ? '' : value);
    };

    chips.forEach(chip => {
      chip.addEventListener('click', () => {
        chips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        filterTiles();
      });
    });

    if (searchInput) {
      let debounce;
      searchInput.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(filterTiles, 120);
      });
    }

    clearBtn?.addEventListener('click', () => {
      searchInput.value = '';
      filterTiles();
    });

    sortSelect?.addEventListener('change', () => {
      sortTiles();
      filterTiles();
    });

    resetFilters?.addEventListener('click', () => {
      searchInput.value = '';
      chips.forEach(c => c.classList.remove('active'));
      chips[0]?.classList.add('active');
      sortSelect.value = 'default';
      sortTiles();
      filterTiles();
    });

    const params = new URLSearchParams(window.location.search);
    const q = (params.get('q') || '').trim();
    const filter = (params.get('filter') || '').trim();
    const sort = (params.get('sort') || '').trim();
    if (searchInput && q) searchInput.value = q;
    if (filter) {
      chips.forEach(c => c.classList.remove('active'));
      const target = chips.find(c => c.dataset.filter === filter);
      if (target) target.classList.add('active');
    }
    if (sortSelect && sort) sortSelect.value = sort;

    sortTiles();
    filterTiles();
  })();
</script>

<%- include('partials/footer') %>
