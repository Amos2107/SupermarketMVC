<%- include('partials/header') %>
<%- include('partials/navbar') %>

<style>
  .shop-hero {
    background: linear-gradient(135deg, #0d47a1, #0f6fde);
    border-radius: 18px;
    padding: 28px;
    color: #fff;
    box-shadow: 0 15px 35px rgba(13, 71, 161, 0.18);
  }
  .product-card {
    border-radius: 14px;
    transition: 0.25s ease;
    border: 1px solid rgba(13, 71, 161, 0.08);
  }
  .product-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.12);
  }
  .product-image {
    max-height: 160px;
    object-fit: contain;
  }
  .search-row {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    padding: 16px;
  }
  .stock-badge {
    border-radius: 999px;
    font-size: 0.8rem;
  }
</style>

<div class="container py-4">
  <div class="shop-hero mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <p class="mb-1 text-uppercase small opacity-75">Explore</p>
      <h2 class="fw-bold mb-1">Start Shopping</h2>
      <p class="mb-0">Browse fresh picks, add to cart, and checkout fast.</p>
    </div>
    <a href="/cart" class="btn btn-light text-primary fw-semibold">View Cart</a>
  </div>

  <div class="search-row mb-4">
    <div class="row g-2 align-items-center">
      <div class="col-sm-8">
        <label for="productSearch" class="form-label mb-1 text-muted small">Search products</label>
        <input id="productSearch" type="search" class="form-control" placeholder="Search by name...">
      </div>
      <div class="col-sm-4 text-sm-end text-muted small">
        Showing all items. Use search to filter by name.
      </div>
    </div>
  </div>

  <div class="row g-4" id="productGrid">
    <% products.forEach(product => { 
         const inStock = product.quantity > 0;
         const lowStock = inStock && product.quantity <= 5;
    %>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 product-tile" data-name="<%= product.productName.toLowerCase() %>">
        <div class="card h-100 shadow-sm product-card">
          <a href="/product/<%= product.id %>" class="text-center mt-3">
            <img 
              src="/images/<%= product.image %>" 
              class="card-img-top img-fluid product-image"
              alt="<%= product.productName %>"
              loading="lazy"
              onerror="this.src='/images/placeholder.png';"
            />
          </a>

          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="card-title fw-semibold text-truncate mb-0" title="<%= product.productName %>">
                <%= product.productName %>
              </h6>
              <% if (!inStock) { %>
                <span class="badge bg-secondary stock-badge">Out of stock</span>
              <% } else if (lowStock) { %>
                <span class="badge bg-warning text-dark stock-badge">Low stock</span>
              <% } else { %>
                <span class="badge bg-success stock-badge">In stock</span>
              <% } %>
            </div>

            <p class="card-text fs-5 fw-bold text-primary mb-2">
              $<%= Number(product.price).toFixed(2) %>
            </p>

            <div class="mb-3">
              <label class="form-label small text-muted">Quantity</label>
              <select name="quantity" class="form-select" form="addToCartForm-<%= product.id %>" <%= inStock ? '' : 'disabled' %>>
                <% for (let q = 1; q <= 10; q++) { %>
                  <option value="<%= q %>"><%= q %></option>
                <% } %>
              </select>
            </div>

            <form 
              id="addToCartForm-<%= product.id %>" 
              action="/cart/add/<%= product.id %>" 
              method="POST" 
              class="mt-auto"
            >
              <button type="submit" class="btn btn-outline-primary w-100 fw-semibold" <%= inStock ? '' : 'disabled' %>>
                <%= inStock ? 'Add to Cart' : 'Out of Stock' %>
              </button>
            </form>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<script>
  (function() {
    const searchInput = document.getElementById('productSearch');
    const tiles = Array.from(document.querySelectorAll('.product-tile'));

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const term = e.target.value.trim().toLowerCase();
        tiles.forEach(tile => {
          const name = tile.dataset.name || '';
          tile.style.display = !term || name.includes(term) ? '' : 'none';
        });
      });
    }
  })();
</script>

<%- include('partials/footer') %>
