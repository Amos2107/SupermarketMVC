<%- include('partials/header') %>
<%- include('partials/navbar') %>

<%
  const refundRequestSafe = typeof refundRequest !== 'undefined' ? refundRequest : null;
  const formatDate = (d) => {
    if (!d) return '-';
    if (d.toLocaleString) return d.toLocaleString();
    return d;
  };
  const itemsSubtotal = items.reduce((sum, item) => sum + (Number(item.priceAtTime) || 0) * (Number(item.quantity) || 0), 0);
  const orderTotal = Number(order.totalAmount || order.total || itemsSubtotal || 0);
  const taxAmount = 0;
  const discountAmount = 0;
  const statusText = order.status || 'Pending';
  const statusLower = String(statusText).toLowerCase();
  const statusBadgeClass = statusLower === 'paid' ? 'text-bg-success' : (statusLower.includes('refund') ? 'text-bg-info' : (statusLower === 'cancelled' ? 'text-bg-danger' : 'text-bg-warning'));
  const refundStatus = refundRequestSafe ? String(refundRequestSafe.status || '').toLowerCase() : '';
%>

<div class="container py-4">
  <div class="invoice-card bg-white p-4 rounded-3 shadow-sm">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 invoice-header">
      <div>
        <div class="text-uppercase text-muted small">Invoice</div>
        <h2 class="mb-1">Invoice #<%= order.id %></h2>
        <div class="text-muted small">Issued: <%= formatDate(order.created_at) %></div>
        <div class="mt-2">
          <span class="badge <%= statusBadgeClass %>"><%= statusText %></span>
          <% if (statusLower === 'paid') { %>
            <span class="text-muted small ms-2">Paid at: <%= formatDate(order.paid_at) %></span>
          <% } %>
          <% if (refundStatus) { %>
            <span class="badge <%= refundStatus === 'approved' ? 'text-bg-success' : (refundStatus === 'rejected' ? 'text-bg-danger' : 'text-bg-secondary') %> ms-2">Refund <%= refundRequestSafe.status %></span>
            <a class="ms-2 small text-decoration-none" href="/refunds">View refund request</a>
          <% } else if (statusLower.includes('refund')) { %>
            <a class="ms-2 small text-decoration-none" href="/refunds">View refund details</a>
          <% } %>
        </div>
      </div>
      <div class="text-end">
        <div class="fw-semibold">AmosMart</div>
        <div class="text-muted small">SupermarketMVC</div>
        <div class="text-muted small">Payment Technologies</div>
      </div>
    </div>

    <div class="invoice-meta mt-4">
      <div>
        <div class="text-muted small">Bill To</div>
        <div class="fw-semibold"><%= user.username %></div>
        <div class="text-muted small"><%= user.email %></div>
        <% if (user.address) { %>
          <div class="text-muted small"><%= user.address %></div>
        <% } %>
        <% if (user.contact) { %>
          <div class="text-muted small"><%= user.contact %></div>
        <% } %>
      </div>
      <div class="text-end">
        <div class="text-muted small">Payment Method</div>
        <div class="fw-semibold text-capitalize"><%= order.payment_method || '-' %></div>
        <div class="text-muted small mt-2">Reference</div>
        <div class="fw-semibold"><%= order.payment_provider_ref || '-' %></div>
      </div>
    </div>

    <div class="table-responsive mt-4">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Image</th>
          <th>Price ($)</th>
          <th>Quantity</th>
          <th>Subtotal ($)</th>
        </tr>
      </thead>
      <tbody>
        <% items.forEach(item => { %>
          <tr>
            <td><%= item.productName %></td>
            <td>
              <img src="/images/<%= item.image %>" class="img-thumbnail" style="max-width: 80px;">
            </td>
            <td>$<%= Number(item.priceAtTime).toFixed(2) %></td>
            <td><%= item.quantity %></td>
            <td>$<%= (item.priceAtTime * item.quantity).toFixed(2) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    </div>

    <div class="invoice-totals mt-3">
      <div class="d-flex justify-content-between">
        <span class="text-muted">Subtotal</span>
        <span>$<%= itemsSubtotal.toFixed(2) %></span>
      </div>
      <div class="d-flex justify-content-between">
        <span class="text-muted">Tax</span>
        <span>$<%= taxAmount.toFixed(2) %></span>
      </div>
      <div class="d-flex justify-content-between">
        <span class="text-muted">Discount</span>
        <span>-$<%= discountAmount.toFixed(2) %></span>
      </div>
      <hr>
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Total</span>
        <h4 class="mb-0 text-primary">$<%= orderTotal.toFixed(2) %></h4>
      </div>
    </div>

    <div class="invoice-actions d-flex justify-content-between mt-4">
      <div class="d-flex gap-2">
        <a href="/orders" class="btn btn-outline-secondary">Back to Orders</a>
        <a href="/shopping" class="btn btn-outline-primary">Continue Shopping</a>
      </div>
      <button class="btn btn-primary" type="button" onclick="window.print()">Print / Save PDF</button>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
