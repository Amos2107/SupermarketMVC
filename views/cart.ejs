<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container py-4">
  <div class="breadcrumb-bar mb-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Cart</li>
      </ol>
    </nav>
  </div>
  <div class="mb-3 d-flex flex-wrap align-items-center justify-content-between gap-2">
    <div class="stepper">
      <div class="step active">1. Review</div>
      <div class="step-line"></div>
      <div class="step">2. Payment</div>
      <div class="step-line"></div>
      <div class="step">3. Confirmation</div>
    </div>
    <div class="results-count">Step 1 of 3</div>
  </div>
  <div class="cart-hero mb-4 d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
      <p class="mb-1 text-uppercase small opacity-75">Your basket</p>
      <h3 class="fw-bold mb-0">Cart</h3>
    </div>
    <a href="/shopping" class="btn btn-light text-primary fw-semibold">Back to Shopping</a>
  </div>

<% if (cart.length === 0) { %>
  <div class="text-center py-4 bg-white rounded-3 shadow-sm">
    <p class="mb-2">Your cart is empty.</p>
    <a href="/shopping" class="btn btn-primary">Start shopping</a>
  </div>
<% } else { %>
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="search-row mb-3">
        <label for="cartSearch" class="form-label mb-1 text-muted small">Search in cart</label>
        <input id="cartSearch" type="search" class="form-control" placeholder="Search by product name..." aria-label="Search cart items">
      </div>
        <div class="table-responsive cart-table">
          <table class="table table-sticky align-middle bg-white shadow-sm">
            <thead class="text-center">
              <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% let total = 0; %>
              <% cart.forEach(item => { %>
                <% total += item.priceAtTime * item.quantity; %>
                <tr class="text-center cart-row" data-name="<%= item.productName.toLowerCase() %>" data-qty="<%= item.quantity %>" data-price="<%= item.priceAtTime %>">
                  <td><%= item.productName %></td>
                  <td><img src="/images/<%= item.image %>" class="img-thumbnail" style="max-width: 70px;"></td>
                  <td>$<%= Number(item.priceAtTime).toFixed(2) %></td>
                  <td>
                    <form action="/cart/update/<%= item.cartItemId %>" method="POST" class="d-flex justify-content-center gap-2 cart-update-form">
                      <select name="quantity" class="form-select w-auto cart-qty-select" aria-label="Select quantity">
                        <% for (let q = 1; q <= 10; q++) { %>
                          <option value="<%= q %>" <%= item.quantity === q ? "selected" : "" %>><%= q %></option>
                        <% } %>
                      </select>
                      <button class="btn btn-outline-primary btn-sm">Update</button>
                    </form>
                  </td>
                  <td>$<%= (item.priceAtTime * item.quantity).toFixed(2) %></td>
                  <td>
                    <form action="/cart/delete/<%= item.cartItemId %>" method="POST">
                      <button class="btn btn-outline-danger btn-sm">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
              <tr id="cartNoResults" class="text-center text-muted" style="display:none;">
                <td colspan="6">No items match your search.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="cart-summary p-4 sticky-summary">
          <h5 class="fw-semibold mb-3">Order Summary</h5>
          <div class="d-flex justify-content-between mb-2">
            <span>Items</span>
            <span id="cartCount"><%= cart.length %></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <strong id="cartSubtotal">$<%= total.toFixed(2) %></strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-semibold">Total</span>
            <h4 class="mb-0 text-primary" id="cartTotal">$<%= total.toFixed(2) %></h4>
          </div>
          <div id="cartInlineStatus" class="inline-status mb-2 d-none">Updating cart...</div>
          <div class="d-grid gap-2">
            <form action="/checkout" method="POST" class="d-grid">
              <button type="submit" class="btn btn-primary">Checkout</button>
            </form>
            <form action="/cart/clear" method="GET" class="d-grid">
              <button type="submit" class="btn btn-outline-danger">Clear Cart</button>
            </form>
          </div>
        </div>
      </div>
  </div>
<% } %>
</div>

<script>
  (function() {
    const searchInput = document.getElementById('cartSearch');
    const rows = Array.from(document.querySelectorAll('.cart-row'));
    const noResultsRow = document.getElementById('cartNoResults');
    const updateForms = Array.from(document.querySelectorAll('.cart-update-form'));
    const qtySelects = Array.from(document.querySelectorAll('.cart-qty-select'));
    const inlineStatus = document.getElementById('cartInlineStatus');

    const filterRows = () => {
      const term = (searchInput?.value || '').trim().toLowerCase();
      let visibleCount = 0;

      rows.forEach((row) => {
        const name = row.dataset.name || '';
        const show = !term || name.includes(term);
        row.style.display = show ? '' : 'none';
        if (show) visibleCount += 1;
      });

      if (noResultsRow) noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    };

    if (searchInput) {
      let debounce;
      searchInput.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(filterRows, 100);
      });
    }

    filterRows();

    const setInlineStatus = (show) => {
      if (!inlineStatus) return;
      inlineStatus.classList.toggle('d-none', !show);
    };

    qtySelects.forEach((select) => {
      select.addEventListener('change', () => {
        const form = select.closest('form');
        if (!form) return;
        setInlineStatus(true);
        updateForms.forEach((f) => {
          const btn = f.querySelector('button');
          if (btn) btn.disabled = true;
          const sel = f.querySelector('select');
          if (sel) sel.disabled = true;
        });
        form.submit();
      });
    });
  })();
</script>

<%- include('partials/footer') %>
