<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container py-4">
  <h2 class="mb-4">All Orders</h2>

  <div class="search-row mb-3">
    <label for="orderSearch" class="form-label mb-1 text-muted small">Search orders</label>
    <input id="orderSearch" type="search" class="form-control" placeholder="Search by user or order ID..." aria-label="Search orders">
  </div>

  <table class="table table-bordered text-center">
    <thead class="table-dark">
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Date</th>
        <th>Total ($)</th>
        <th>Payment</th>
        <th>Paid Date</th>
        <th>Status</th>
        <th>View</th>
      </tr>
    </thead>

    <tbody>
      <% orders.forEach(order => { %>
        <% const statusText = (order.status || 'Pending'); %>
        <% const statusLower = String(statusText).toLowerCase(); %>
        <% const statusBadgeClass = statusLower === 'paid' ? 'text-bg-success' : (statusLower.includes('refund') ? 'text-bg-info' : (statusLower === 'cancelled' ? 'text-bg-danger' : 'text-bg-warning')); %>
        <tr class="order-row" data-id="<%= String(order.id).toLowerCase() %>" data-user="<%= (order.username || '').toLowerCase() %>">
          <td><%= order.id %></td>
          <td><%= order.username %></td>
          <td><%= order.created_at.toDateString() %></td>
          <td>$<%= Number(order.totalAmount).toFixed(2) %></td>
          <td class="text-capitalize"><%= order.payment_method || '-' %></td>
          <td><%= order.paid_at ? new Date(order.paid_at).toDateString() : '-' %></td>
          <td><span class="badge <%= statusBadgeClass %>"><%= statusText %></span></td>
          <td>
            <a href="/orders/<%= order.id %>" class="btn btn-primary btn-sm">Details</a>
          </td>
        </tr>
      <% }) %>
      <tr id="ordersNoResults" class="text-center text-muted" style="display:none;">
        <td colspan="8">No orders match your search.</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  (function() {
    const searchInput = document.getElementById('orderSearch');
    const rows = Array.from(document.querySelectorAll('.order-row'));
    const noResults = document.getElementById('ordersNoResults');

    const filter = () => {
      const term = (searchInput?.value || '').trim().toLowerCase();
      let visible = 0;

      rows.forEach((row) => {
        const id = row.dataset.id || '';
        const user = row.dataset.user || '';
        const show = !term || id.includes(term) || user.includes(term);
        row.style.display = show ? '' : 'none';
        if (show) visible += 1;
      });

      if (noResults) noResults.style.display = visible === 0 ? '' : 'none';
    };

    if (searchInput) {
      let debounce;
      searchInput.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(filter, 100);
      });
    }
  })();
</script>

<%- include('partials/footer') %>
