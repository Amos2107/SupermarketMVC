<%- include('partials/header') %>
<%- include('partials/navbar') %>

<style>
  .order-hero {
    background: linear-gradient(135deg, #0d47a1, #0f6fde);
    color: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 12px 28px rgba(13, 71, 161, 0.18);
  }
</style>

<div class="container py-4">
  <div class="breadcrumb-bar mb-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/orders">My Orders</a></li>
        <li class="breadcrumb-item active" aria-current="page">#<%= order.id %></li>
      </ol>
    </nav>
  </div>

  <div class="mb-3 d-flex flex-wrap align-items-center justify-content-between gap-2">
    <%
      const statusLower = String(order.status || '').toLowerCase();
      const stepPaid = statusLower === 'paid';
      const isCancelled = statusLower === 'cancelled';
      const isRefunded = statusLower.includes('refund');
    %>
    <div class="stepper">
      <div class="step done">1. Review</div>
      <div class="step-line done"></div>
      <div class="step <%= stepPaid || isRefunded ? 'done' : (isCancelled ? '' : 'active') %>">2. Payment</div>
      <div class="step-line <%= stepPaid || isRefunded ? 'done' : '' %>"></div>
      <div class="step <%= stepPaid || isCancelled || isRefunded ? 'active' : '' %>">3. <%= isCancelled ? 'Cancelled' : (isRefunded ? 'Refunded' : 'Confirmation') %></div>
    </div>
    <div class="results-count"><%= stepPaid ? 'Paid' : (isRefunded ? 'Refunded' : (isCancelled ? 'Cancelled' : 'Awaiting payment')) %></div>
  </div>

  <div class="order-hero d-flex justify-content-between align-items-center mb-4">
    <div>
      <p class="mb-1 text-uppercase small opacity-75">Order</p>
      <h3 class="fw-bold mb-0">Order #<%= order.id %></h3>
    </div>
    <div class="text-end">
      <div class="small opacity-75">Date</div>
      <div><%= order.created_at.toDateString() %></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-3 shadow-sm mb-3">
    <div class="d-flex justify-content-between flex-wrap gap-2">
      <span><strong>Total:</strong> $<%= Number(order.totalAmount).toFixed(2) %></span>
      <span><strong>Customer:</strong> <%= order.username || '' %></span>
      <span><strong>Status:</strong> <%= order.status || 'Pending' %></span>
    </div>
    <% if ((String(order.status || '')).toLowerCase() !== 'paid' && (String(order.status || '')).toLowerCase() !== 'cancelled' && !(String(order.status || '')).toLowerCase().includes('refund')) { %>
      <div class="mt-3 d-flex gap-2 flex-wrap">
        <a class="btn btn-primary" href="/orders/<%= order.id %>/pay">Pay Now</a>
        <form action="/orders/<%= order.id %>/cancel" method="POST" onsubmit="return confirm('Cancel this order?');">
          <button class="btn btn-outline-danger" type="submit">Cancel Order</button>
        </form>
        <span class="text-muted small align-self-center">Payment method: <%= order.payment_method || '-' %></span>
      </div>
    <% } else if ((String(order.status || '')).toLowerCase() === 'paid') { %>
      <div class="mt-3 text-muted small">Paid at: <%= order.paid_at ? new Date(order.paid_at).toLocaleString() : '-' %></div>
      <% if (refundRequest && String(refundRequest.status || '').toLowerCase() === 'pending') { %>
        <div class="mt-2 text-muted small">Refund request submitted and pending admin approval.</div>
      <% } else if (canRequestRefund) { %>
        <div class="mt-3">
          <a class="btn btn-outline-danger" href="/refunds/new?orderId=<%= order.id %>">Request Refund</a>
        </div>
      <% } %>
    <% } else { %>
      <div class="mt-3 text-muted small"><%= isRefunded ? 'Order refunded.' : 'Order cancelled.' %></div>
    <% } %>
  </div>

  <div class="bg-white p-4 rounded-3 shadow-sm mb-3">
    <h6 class="fw-semibold mb-3">Order timeline</h6>
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-dot active"></div>
        <div>
          <div class="fw-semibold">Order created</div>
          <div class="text-muted small"><%= order.created_at ? new Date(order.created_at).toLocaleString() : '-' %></div>
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-dot <%= isCancelled ? '' : ((stepPaid || isRefunded) ? 'active' : 'pending') %>"></div>
        <div>
          <div class="fw-semibold">Payment <%= isCancelled ? 'cancelled' : (isRefunded ? 'refunded' : (stepPaid ? 'completed' : 'pending')) %></div>
          <div class="text-muted small"><%= isCancelled ? 'Order cancelled before payment' : (isRefunded ? 'Refund processed' : (stepPaid ? (order.paid_at ? new Date(order.paid_at).toLocaleString() : '-') : 'Awaiting payment')) %></div>
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-dot <%= stepPaid || isCancelled || isRefunded ? 'active' : '' %>"></div>
        <div>
          <div class="fw-semibold"><%= isCancelled ? 'Order cancelled' : (isRefunded ? 'Order refunded' : 'Confirmation') %></div>
          <div class="text-muted small"><%= isCancelled ? 'Cancellation recorded' : (isRefunded ? 'Refund recorded' : (stepPaid ? 'Order confirmed' : 'After payment')) %></div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-sticky bg-white shadow-sm align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Image</th>
          <th>Qty</th>
          <th>Price ($)</th>
          <th>Subtotal ($)</th>
        </tr>
      </thead>
      <tbody>
        <% items.forEach(item => { %>
          <tr>
            <td><%= item.productName %></td>
            <td>
              <img
                src="/images/<%= item.image %>"
                style="max-width:70px;"
                alt="<%= item.productName %>"
                onerror="this.src='/images/placeholder.png';"
              >
            </td>
            <td><%= item.quantity %></td>
            <td>$<%= Number(item.priceAtTime).toFixed(2) %></td>
            <td>$<%= (item.priceAtTime * item.quantity).toFixed(2) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <a href="/orders" class="btn btn-secondary">Back</a>
</div>

<%- include('partials/footer') %>
